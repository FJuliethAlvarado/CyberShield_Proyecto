{% extends 'base.html' %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-12">
        <div class="card shadow-lg border-0">
            <!-- Header -->
            <div class="card-header bg-success text-white py-4">
                <div class="text-center">
                    <i class="fas fa-table fa-2x mb-3"></i>
                    <h1 class="h2 mb-2">Análisis de Archivos Contables</h1>
                    <p class="mb-0 opacity-75">Visualización completa con detección de anomalías en tiempo real</p>
                </div>
            </div>

            <div class="card-body p-4">
                <!-- Área de Upload -->
                <div class="upload-area mb-4 p-5 text-center border-3 border-dashed rounded-3" 
                    id="uploadArea"
                    style="border-style: dashed; border-color: #dee2e6; background: #f8f9fa;">
                    <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted mb-3">Sube tu archivo para análisis</h4>
                    <p class="text-muted mb-4">Formatos: CSV, Excel (XLSX, XLS)</p>
                    
                    <form method="POST" action="/upload" enctype="multipart/form-data" id="uploadForm">
                        <input type="file" name="file" id="fileInput" 
                            class="d-none" 
                            accept=".csv,.xlsx,.xls" 
                            required>
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="fas fa-search me-2"></i>Analizar Archivo
                        </button>
                    </form>
                    
                    <div class="mt-3" id="fileInfo"></div>
                </div>

                {% if analisis %}
                <div class="analysis-results">
                    <!-- Resumen del Análisis -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body text-center">
                                    <i class="fas fa-file-alt fa-2x mb-2"></i>
                                    <h4>{{ analisis.total_registros }}</h4>
                                    <small>Registros</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-info text-white">
                                <div class="card-body text-center">
                                    <i class="fas fa-columns fa-2x mb-2"></i>
                                    <h4>{{ analisis.total_columnas }}</h4>
                                    <small>Columnas</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 fade-in delay-3">
                                <!-- CORRECCIÓN DEL COLOR DEL NIVEL DE RIESGO -->
                                {% set riesgo_color = 'danger' if 'Alto' in analisis.nivel_riesgo or 'Muy Alto' in analisis.nivel_riesgo else 'warning' if 'Medio' in analisis.nivel_riesgo else 'success' %}
                                <div class="card bg-{{ riesgo_color }} text-white h-100">
                                    <div class="card-body text-center d-flex flex-column justify-content-center">
                                    <i class="fas fa-shield-alt fa-2x mb-2"></i>
                                    <h4>{{ analisis.nivel_riesgo }}</h4>
                                    <small>Nivel de Riesgo</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-secondary text-white">
                                <div class="card-body text-center">
                                    <i class="fas fa-chart-line fa-2x mb-2"></i>
                                    <h4>{{ analisis.puntuacion_riesgo }}/100</h4>
                                    <small>Puntuación</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Anomalías Detectadas -->
                    {% if analisis.anomalias %}
                    <div class="alert alert-warning mb-4">
                        <h5><i class="fas fa-exclamation-triangle me-2"></i>Anomalías Detectadas: {{ analisis.anomalias|length }}</h5>
                        <div class="row">
                            {% for anomalia in analisis.anomalias[:6] %}
                            <div class="col-md-6 mb-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span>
                                        <i class="fas fa-{{ 'exclamation-circle' if 'URGENTE' in anomalia.tipo else 'info-circle' }} me-2"></i>
                                        <strong>{{ anomalia.tipo }}</strong>
                                        {% if anomalia.columna %}<small class="text-muted"> ({{ anomalia.columna }})</small>{% endif %}
                                    </span>
                                    <span class="badge bg-{{ 'danger' if 'URGENTE' in anomalia.tipo or 'CRÍTICO' in anomalia.tipo else 'warning' }}">
                                        {{ anomalia.cantidad if anomalia.cantidad else anomalia.porcentaje }}
                                    </span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- ========== GRÁFICOS DE ANÁLISIS CORREGIDOS ========== -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-chart-bar me-2"></i>Visualización de Análisis
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <!-- Gráfico de anomalías por categoría -->
                                <div class="col-md-6 mb-4">
                                    <div class="chart-container">
                                        <h6 class="text-center mb-3">Distribución de Anomalías por Categoría</h6>
                                        <canvas id="anomaliesChart"></canvas>
                                    </div>
                                </div>
                                
                                <!-- Gráfico de valores nulos -->
                                <div class="col-md-6 mb-4">
                                    <div class="chart-container">
                                        <h6 class="text-center mb-3">Top 10 Columnas con Valores Nulos</h6>
                                        <canvas id="nullsChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Gráfico de distribución de valores -->
                            {% if analisis.graficas.distribucion_valores %}
                            <div class="row mt-4">
                                <div class="col-12">
                                    <h6 class="text-center mb-3">Distribución de Valores Numéricos</h6>
                                </div>
                                {% for columna, datos in analisis.graficas.distribucion_valores.items() %}
                                <div class="col-md-4 mb-4">
                                    <div class="card">
                                        <div class="card-header bg-light py-2">
                                            <h6 class="mb-0 text-center">{{ columna }}</h6>
                                        </div>
                                        <div class="card-body">
                                            <canvas id="dist_{{ loop.index }}"></canvas>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- ========== MAPA DE CALOR ========== -->
                    <div class="card mb-4">
                        <div class="card-header bg-danger text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-fire me-2"></i>Mapa de Calor de Anomalías
                            </h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive" style="max-height: 400px; overflow: auto;">
                                <table class="table table-sm mb-0" id="heatmapTable">
                                    <thead class="sticky-top bg-light">
                                        <tr>
                                            <th class="bg-light">#</th>
                                            {% for columna in analisis.columnas %}
                                            <th class="bg-light">{{ columna }}</th>
                                            {% endfor %}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for fila in analisis.datos_preview %}
                                        <tr>
                                            <td class="bg-light"><strong>{{ loop.index }}</strong></td>
                                            {% for columna in analisis.columnas %}
                                            {% set valor = fila[columna] %}
                                            {% set riesgo = analisis.mapa_calor[loop.index0][columna] if loop.index0 < analisis.mapa_calor|length else 0 %}
                                            <td class="heatmap-cell" 
                                                data-risk="{{ riesgo }}"
                                                style="background-color: {{ 
                                                    'rgba(220, 53, 69, 0.8)' if riesgo == 3 else 
                                                    'rgba(255, 193, 7, 0.6)' if riesgo == 2 else 
                                                    'rgba(13, 202, 240, 0.3)' if riesgo == 1 else 
                                                    'white' 
                                                }}; {{ 'color: white; font-weight: bold;' if riesgo >= 2 else '' }}">
                                                {{ valor if valor != 'N/A' else '—' }}
                                                {% if riesgo >= 2 %}
                                                <i class="fas fa-exclamation-triangle ms-1"></i>
                                                {% endif %}
                                            </td>
                                            {% endfor %}
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="card-footer bg-light">
                            <div class="row text-center">
                                <div class="col-3">
                                    <span class="badge" style="background-color: white; color: black; border: 1px solid #ddd;">Sin riesgo</span>
                                </div>
                                <div class="col-3">
                                    <span class="badge" style="background-color: rgba(13, 202, 240, 0.3); color: black;">Bajo</span>
                                </div>
                                <div class="col-3">
                                    <span class="badge" style="background-color: rgba(255, 193, 7, 0.6); color: black;">Medio</span>
                                </div>
                                <div class="col-3">
                                    <span class="badge" style="background-color: rgba(220, 53, 69, 0.8); color: white;">Alto</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabla de Datos Completa -->
                    <div class="card mb-4">
                        <div class="card-header bg-dark text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-table me-2"></i>Vista Completa - {{ analisis.archivo_nombre }}
                            </h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive" style="max-height: 600px;">
                                <table class="table table-striped table-hover mb-0" id="dataTable">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            {% for columna in analisis.columnas %}
                                            <th>{{ columna }}</th>
                                            {% endfor %}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for fila in analisis.datos_preview %}
                                        <tr>
                                            {% for columna in analisis.columnas %}
                                            <td>{{ fila[columna] if fila[columna] != 'N/A' else '—' }}</td>
                                            {% endfor %}
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Botones de Acción -->
                    <div class="text-center mb-4">
                        <a href="/upload" class="btn btn-success me-2">
                            <i class="fas fa-upload me-2"></i>Analizar Otro Archivo
                        </a>
                        <button class="btn btn-outline-primary me-2" onclick="window.print()">
                            <i class="fas fa-print me-2"></i>Imprimir Reporte
                        </button>
                        <a href="/" class="btn btn-outline-secondary">
                            <i class="fas fa-home me-2"></i>Volver al Inicio
                        </a>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
.upload-area {
    transition: all 0.3s ease;
    cursor: pointer;
}

.upload-area:hover {
    border-color: #198754 !important;
    background: #e8f5e8 !important;
}

.chart-container {
    position: relative;
    height: 300px;
}

.heatmap-cell {
    transition: all 0.2s;
    padding: 8px;
    font-size: 0.9rem;
}

.heatmap-cell:hover {
    transform: scale(1.05);
    box-shadow: 0 0 5px rgba(0,0,0,0.3);
    z-index: 10;
}

.sticky-top {
    position: sticky;
    top: 0;
    z-index: 100;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Manejo de upload
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const uploadForm = document.getElementById('uploadForm');

    if (uploadArea && fileInput) {
        uploadArea.addEventListener('click', () => fileInput.click());
        
        fileInput.addEventListener('change', function() {
            if (this.files.length > 0) {
                uploadForm.submit();
            }
        });
    }

    {% if analisis %}
    // ========== GRÁFICAS CORREGIDAS ==========
    
    // Gráfico de anomalías por categoría
    const anomaliesCtx = document.getElementById('anomaliesChart');
    if (anomaliesCtx) {
        const anomaliesData = {{ analisis.graficas.anomalias_por_tipo | tojson }};
        
        new Chart(anomaliesCtx, {
            type: 'doughnut',
            data: {
                labels: anomaliesData.labels,
                datasets: [{
                    data: anomaliesData.data,
                    backgroundColor: [
                        '#FF6384', '#36A2EB', '#FFCE56', 
                        '#4BC0C0', '#9966FF', '#FF9F40'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }

    // Gráfico de valores nulos
    const nullsCtx = document.getElementById('nullsChart');
    if (nullsCtx) {
        const nullsData = {{ analisis.graficas.nulos_por_columna | tojson }};
        
        new Chart(nullsCtx, {
            type: 'bar',
            data: {
                labels: nullsData.labels,
                datasets: [{
                    label: 'Valores Nulos',
                    data: nullsData.data,
                    backgroundColor: '#dc3545'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    // Gráficos de distribución
    {% if analisis.graficas.distribucion_valores %}
    {% for columna, datos in analisis.graficas.distribucion_valores.items() %}
    const distCtx{{ loop.index }} = document.getElementById('dist_{{ loop.index }}');
    if (distCtx{{ loop.index }}) {
        new Chart(distCtx{{ loop.index }}, {
            type: 'bar',
            data: {
                labels: {{ datos.bins | tojson }},
                datasets: [{
                    label: 'Frecuencia',
                    data: {{ datos.counts | tojson }},
                    backgroundColor: '#0d6efd'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    {% endfor %}
    {% endif %}
    {% endif %}
});
</script>

{% endblock %}
