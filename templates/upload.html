    {% extends 'base.html' %}

    {% block content %}
    <div class="row justify-content-center">
        <div class="col-lg-12">
            <div class="card shadow-lg border-0">
                <!-- Header -->
                <div class="card-header bg-success text-white py-4">
                    <div class="text-center">
                        <i class="fas fa-table fa-2x mb-3"></i>
                        <h1 class="h2 mb-2">Análisis de Archivos Contables</h1>
                        <p class="mb-0 opacity-75">Visualización completa con detección de anomalías en tiempo real</p>
                    </div>
                </div>

                <div class="card-body p-4">
                    <!-- Área de Upload -->
                    <div class="upload-area mb-4 p-5 text-center border-3 border-dashed rounded-3" 
                        id="uploadArea"
                        style="border-style: dashed; border-color: #dee2e6; background: #f8f9fa;">
                        <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                        <h4 class="text-muted mb-3">Sube tu archivo para análisis</h4>
                        <p class="text-muted mb-4">Formatos: CSV, Excel (XLSX, XLS)</p>
                        
                        <form method="POST" action="/upload" enctype="multipart/form-data" id="uploadForm">
                            <input type="file" name="file" id="fileInput" 
                                class="d-none" 
                                accept=".csv,.xlsx,.xls" 
                                required>
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-search me-2"></i>Analizar Archivo
                            </button>
                        </form>
                        
                        <div class="mt-3" id="fileInfo"></div>
                    </div>

                    <!-- Resultados del Análisis - ESTE ES EL BLOQUE PRINCIPAL -->
                    {% if analisis %}
                    <div class="analysis-results">
                        <!-- Campo oculto para el total de registros -->
                        <input type="hidden" id="totalRegistros" value="{{ analisis.total_registros }}">

                        <!-- Resumen del Análisis -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card bg-primary text-white">
                                    <div class="card-body text-center">
                                        <i class="fas fa-file-alt fa-2x mb-2"></i>
                                        <h4>{{ analisis.total_registros }}</h4>
                                        <small>Registros</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-info text-white">
                                    <div class="card-body text-center">
                                        <i class="fas fa-columns fa-2x mb-2"></i>
                                        <h4>{{ analisis.total_columnas }}</h4>
                                        <small>Columnas</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-{{ 'danger' if analisis.nivel_riesgo == 'Alto' else 'warning' if analisis.nivel_riesgo == 'Medio' else 'success' }} text-white">
                                    <div class="card-body text-center">
                                        <i class="fas fa-shield-alt fa-2x mb-2"></i>
                                        <h4>{{ analisis.nivel_riesgo }}</h4>
                                        <small>Nivel de Riesgo</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-secondary text-white">
                                    <div class="card-body text-center">
                                        <i class="fas fa-chart-line fa-2x mb-2"></i>
                                        <h4>{{ analisis.puntuacion_riesgo }}/100</h4>
                                        <small>Puntuación</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Anomalías Detectadas - PROTEGER ESTA SECCIÓN -->
                        {% if analisis.anomalias %}
                        <div class="alert alert-warning mb-4">
                            <h5><i class="fas fa-exclamation-triangle me-2"></i>Anomalías Detectadas</h5>
                            <div class="row">
                                {% for anomalia in analisis.anomalias %}
                                <div class="col-md-6 mb-2">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span>
                                            <i class="fas fa-{{ 'exclamation-circle' if 'URGENTE' in anomalia.tipo else 'info-circle' }} me-2"></i>
                                            {{ anomalia.tipo }}
                                            {% if anomalia.columna %}<small class="text-muted">({{ anomalia.columna }})</small>{% endif %}
                                        </span>
                                        <span class="badge bg-{{ 'danger' if 'URGENTE' in anomalia.tipo else 'warning' }}">
                                            {{ anomalia.cantidad if anomalia.cantidad else anomalia.porcentaje }}
                                        </span>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        <!-- ========== FILTROS INTERACTIVOS ========== -->
                        <div class="card mb-4">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="fas fa-filter me-2"></i>Filtros Interactivos
                                </h5>
                                <span class="badge bg-primary" id="visibleCount">
                                    Mostrando {{ analisis.datos_preview|length }} de {{ analisis.total_registros }} registros
                                </span>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <!-- Filtro por columna -->
                                    <div class="col-md-4">
                                        <label class="form-label"><strong>Filtrar por Columna</strong></label>
                                        <select class="form-select" id="filterColumn">
                                            <option value="">Todas las columnas</option>
                                            {% for columna in analisis.columnas %}
                                            <option value="{{ columna }}">{{ columna }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    
                                    <!-- Filtro por valor -->
                                    <div class="col-md-4">
                                        <label class="form-label"><strong>Buscar Valor</strong></label>
                                        <input type="text" class="form-control" id="filterValue" placeholder="Escribe para buscar...">
                                    </div>
                                    
                                    <!-- Filtro por anomalías -->
                                    <div class="col-md-4">
                                        <label class="form-label"><strong>Filtrar Registros</strong></label>
                                        <select class="form-select" id="filterAnomaly">
                                            <option value="all">Todos los registros</option>
                                            <option value="anomaly">Solo con problemas</option>
                                            <option value="clean">Solo sin problemas</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Botones de control -->
                                <div class="row mt-3">
                                    <div class="col-md-6">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="highlightAnomalies" checked>
                                            <label class="form-check-label" for="highlightAnomalies">
                                                Resaltar registros problemáticos
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6 text-end">
                                        <button class="btn btn-outline-secondary btn-sm" id="resetFilters">
                                            <i class="fas fa-redo me-1"></i> Reiniciar
                                        </button>
                                        <button class="btn btn-primary btn-sm" id="applyFilters">
                                            <i class="fas fa-search me-1"></i> Aplicar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ========== GRÁFICOS DE ANÁLISIS ========== -->
                        <div class="card mb-4">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-chart-bar me-2"></i>Visualización de Análisis
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <!-- Gráfico de anomalías -->
                                    <div class="col-md-6">
                                        <div class="chart-container">
                                            <h6 class="text-center mb-3">Distribución de Anomalías</h6>
                                            <canvas id="anomaliesChart" width="400" height="300"></canvas>
                                        </div>
                                    </div>
                                    
                                    <!-- Gráfico de valores nulos -->
                                    <div class="col-md-6">
                                        <div class="chart-container">
                                            <h6 class="text-center mb-3">Valores Nulos por Columna</h6>
                                            <canvas id="nullsChart" width="400" height="300"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- TABLA SIMPLIFICADA -->
    <div class="card mb-4">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0">
                <i class="fas fa-table me-2"></i>
                Vista Previa del Archivo - {{ analisis.archivo_nombre }}
            </h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive" style="max-height: 600px;">
                <table class="table table-striped table-hover mb-0" id="dataTable">
                    <thead class="table-light sticky-top">
                        <tr>
                            {% for columna in analisis.columnas %}
                            <th class="position-sticky bg-light top-0">{{ columna }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for fila in analisis.datos_preview %}
                        <tr class="{% if loop.index0 == 7 or loop.index0 == 8 %}table-warning has-anomaly{% endif %}">
                            {% for columna in analisis.columnas %}
                            <td class="{% if (fila[columna] is none or fila[columna] == '') and columna in ['debito','credito','monto'] %}text-danger fw-bold{% endif %}">
                                {{ fila[columna] if fila[columna] is not none else 'N/A' }}
                                {% if (fila[columna] is none or fila[columna] == '') and columna in ['debito','credito','monto'] %}
                                <i class="fas fa-exclamation-circle text-danger ms-1"></i>
                                {% endif %}
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card-footer text-muted">
            <small>
                <i class="fas fa-info-circle me-1"></i>
                Filas amarillas = Posibles duplicados | Texto rojo = Valores críticos faltantes
            </small>
        </div>
    </div>

                        <!-- Estadísticas por Columna -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Estadísticas por Columna</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    {% for columna, stats in analisis.estadisticas_columnas.items() %}
                                    <div class="col-md-6 col-lg-4 mb-3">
                                        <div class="card h-100">
                                            <div class="card-header bg-light py-2">
                                                <h6 class="mb-0">{{ columna }}</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="small">
                                                    <div class="mb-1"><strong>Tipo:</strong> {{ stats.tipo }}</div>
                                                    {% if stats.tipo == 'numérico' %}
                                                    <div class="mb-1"><strong>Promedio:</strong> {{ "%.2f"|format(stats.promedio) }}</div>
                                                    <div class="mb-1"><strong>Mín:</strong> {{ stats.minimo }}</div>
                                                    <div class="mb-1"><strong>Máx:</strong> {{ stats.maximo }}</div>
                                                    {% if stats.nulos > 0 %}
                                                    <div class="mb-1 text-warning"><strong>Nulos:</strong> {{ stats.nulos }}</div>
                                                    {% endif %}
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <!-- Botones de Acción -->
                        <div class="text-center mb-4">
                            <a href="/upload" class="btn btn-success me-2">
                                <i class="fas fa-upload me-2"></i>Analizar Otro Archivo
                            </a>
                            <button class="btn btn-outline-primary me-2" onclick="window.print()">
                                <i class="fas fa-print me-2"></i>Imprimir Reporte
                            </button>
                            <a href="/" class="btn btn-outline-secondary">
                                <i class="fas fa-home me-2"></i>Volver al Inicio
                            </a>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <style>
    .upload-area {
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .upload-area:hover {
        border-color: #198754 !important;
        background: #e8f5e8 !important;
    }

    .upload-area.dragover {
        border-color: #198754 !important;
        background: #d1e7dd !important;
    }

    .table-responsive {
        overflow: auto;
    }

    .position-sticky {
        position: sticky;
        z-index: 10;
    }

    .table-hover tbody tr:hover {
        background-color: rgba(0, 0, 0, 0.075);
    }

    .chart-container {
        position: relative;
        height: 300px;
        margin-bottom: 20px;
    }

    .has-anomaly {
        border-left: 4px solid #ffc107;
    }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // ========== CÓDIGO DE UPLOAD ==========
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const uploadForm = document.getElementById('uploadForm');

        if (uploadArea && fileInput) {
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', function() {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    fileInput.files = files;
                    handleFileSelection(files[0]);
                }
            });

            fileInput.addEventListener('change', function() {
                if (this.files.length > 0) {
                    handleFileSelection(this.files[0]);
                }
            });

            function handleFileSelection(file) {
                fileInfo.innerHTML = `
                    <div class="alert alert-info d-flex align-items-center">
                        <i class="fas fa-file me-3 fa-2x"></i>
                        <div>
                            <strong>${file.name}</strong><br>
                            <small>Tamaño: ${(file.size / 1024 / 1024).toFixed(2)} MB</small>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success btn-lg">
                        <i class="fas fa-search me-2"></i>Analizar Archivo
                    </button>
                `;
                
                setTimeout(() => {
                    uploadForm.submit();
                }, 500);
            }

            uploadArea.addEventListener('click', function() {
                fileInput.click();
            });
        }

        // ========== FILTROS INTERACTIVOS ==========
        // Solo inicializar si existe analisis
        {% if analisis %}
        initializeFilters();
        initializeCharts();
        {% endif %}

        function initializeFilters() {
            const filterColumn = document.getElementById('filterColumn');
            const filterValue = document.getElementById('filterValue');
            const filterAnomaly = document.getElementById('filterAnomaly');
            const highlightAnomalies = document.getElementById('highlightAnomalies');
            const resetFilters = document.getElementById('resetFilters');
            const applyFilters = document.getElementById('applyFilters');

            if (!applyFilters) return;

            // Aplicar filtros automáticamente
            filterValue.addEventListener('input', applyTableFilters);
            filterColumn.addEventListener('change', applyTableFilters);
            filterAnomaly.addEventListener('change', applyTableFilters);

            // Botón aplicar
            applyFilters.addEventListener('click', applyTableFilters);

            // Reiniciar filtros
            resetFilters.addEventListener('click', function() {
                filterColumn.value = '';
                filterValue.value = '';
                filterAnomaly.value = 'all';
                if (highlightAnomalies) highlightAnomalies.checked = true;
                applyTableFilters();
            });

            // Resaltar anomalías
            if (highlightAnomalies) {
                highlightAnomalies.addEventListener('change', function() {
                    document.querySelectorAll('.has-anomaly').forEach(row => {
                        if (this.checked) {
                            row.classList.add('table-warning');
                        } else {
                            row.classList.remove('table-warning');
                        }
                    });
                });
            }
        }

        function applyTableFilters() {
        const rows = document.querySelectorAll('#dataTable tbody tr');
        const filterColumn = document.getElementById('filterColumn');
        const filterValue = document.getElementById('filterValue');
        const filterAnomaly = document.getElementById('filterAnomaly');
        
        if (!rows.length) return;

        let visibleCount = 0;
        const columnFilter = filterColumn ? filterColumn.value : '';
        const valueFilter = filterValue ? filterValue.value.toLowerCase() : '';
        const anomalyFilter = filterAnomaly ? filterAnomaly.value : 'all';
        const totalRegistros = document.getElementById('totalRegistros') ? document.getElementById('totalRegistros').value : rows.length;

        rows.forEach(row => {
            let showRow = true;
            const cells = row.cells;
            const hasAnomaly = row.classList.contains('has-anomaly');

            // Filtro por columna específica
            if (columnFilter && valueFilter) {
                const headerCells = document.querySelectorAll('#dataTable thead th');
                let columnIndex = -1;
                
                for (let i = 0; i < headerCells.length; i++) {
                    if (headerCells[i].textContent.trim() === columnFilter) {
                        columnIndex = i;
                        break;
                    }
                }

                if (columnIndex !== -1 && cells[columnIndex]) {
                    const cellText = cells[columnIndex].textContent.toLowerCase();
                    if (!cellText.includes(valueFilter)) {
                        showRow = false;
                    }
                }
            }
            // Filtro general (sin columna específica)
            else if (valueFilter) {
                let found = false;
                for (let cell of cells) {
                    if (cell.textContent.toLowerCase().includes(valueFilter)) {
                        found = true;
                        break;
                    }
                }
                if (!found) showRow = false;
            }

            // Filtro por anomalías
            if (anomalyFilter === 'anomaly' && !hasAnomaly) {
                showRow = false;
            } else if (anomalyFilter === 'clean' && hasAnomaly) {
                showRow = false;
            }

            // Mostrar/ocultar
            row.style.display = showRow ? '' : 'none';
            if (showRow) visibleCount++;
        });

        // Actualizar contador
        const visibleCountElement = document.getElementById('visibleCount');
        if (visibleCountElement) {
            visibleCountElement.textContent = `Mostrando ${visibleCount} de ${totalRegistros} registros`;
        }
    }
        function initializeCharts() {
            // Gráfico de anomalías
            const anomaliesCtx = document.getElementById('anomaliesChart');
            if (anomaliesCtx) {
                try {
                    // Preparar datos para el gráfico
                    const anomalyLabels = [];
                    const anomalyData = [];
                    const backgroundColors = ['#ff6384', '#36a2eb', '#ffce56', '#4bc0c0', '#9966ff', '#ff9f40', '#c9cbcf'];
                    
                    {% if analisis and analisis.anomalias %}
                        {% for anomalia in analisis.anomalias %}
                        anomalyLabels.push('{{ anomalia.tipo }}');
                        anomalyData.push({{ anomalia.cantidad if anomalia.cantidad else 1 }});
                        {% endfor %}
                    {% endif %}
                    
                    // Solo crear gráfico si hay datos
                    if (anomalyLabels.length > 0) {
                        new Chart(anomaliesCtx, {
                            type: 'doughnut',
                            data: {
                                labels: anomalyLabels,
                                datasets: [{
                                    data: anomalyData,
                                    backgroundColor: backgroundColors.slice(0, anomalyLabels.length)
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: {
                                        position: 'bottom',
                                        labels: {
                                            boxWidth: 12,
                                            font: {
                                                size: 11
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    } else {
                        anomaliesCtx.parentElement.innerHTML = '<p class="text-muted text-center">No hay anomalías para mostrar</p>';
                    }
                } catch (error) {
                    console.error('Error creando gráfico de anomalías:', error);
                    anomaliesCtx.parentElement.innerHTML = '<p class="text-danger text-center">Error al cargar gráfico</p>';
                }
            }

            // Gráfico de valores nulos
            const nullsCtx = document.getElementById('nullsChart');
            if (nullsCtx) {
                try {
                    const columnLabels = [];
                    const nullsData = [];
                    
                    {% if analisis and analisis.estadisticas_columnas %}
                    {% for columna, stats in analisis.estadisticas_columnas.items() %}
                    columnLabels.push('{{ columna }}');
                    nullsData.push({{ stats.nulos }});
                    {% endfor %}
                    {% endif %}
                    
                    if (columnLabels.length > 0) {
                        new Chart(nullsCtx, {
                            type: 'bar',
                            data: {
                                labels: columnLabels,
                                datasets: [{
                                    label: 'Valores Nulos',
                                    data: nullsData,
                                    backgroundColor: '#dc3545',
                                    borderColor: '#c82333',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                scales: {
                                    y: {
                                        beginAtZero: true
                                    },
                                    x: {
                                        ticks: {
                                            maxRotation: 45,
                                            minRotation: 45
                                        }
                                    }
                                }
                            }
                        });
                    }
                } catch (error) {
                    console.error('Error creando gráfico de nulos:', error);
                }
            }
        }
    });
    </script>
    {% endblock %}