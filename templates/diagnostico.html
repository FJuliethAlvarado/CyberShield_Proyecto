{% extends 'base.html' %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10 col-xl-8">
        <div class="card shadow-lg border-0">
            <!-- Header con progreso -->
            <div class="card-header bg-primary text-white py-4">
                <div class="text-center">
                    <i class="fas fa-shield-alt fa-2x mb-3"></i>
                    <h2 class="h1 mb-2">Diagnóstico de Ciberriesgos</h2>
                    <p class="mb-0 opacity-75">Complete el formulario para evaluar los riesgos de seguridad de su empresa</p>
                </div>
                
                <!-- Barra de progreso -->
                <div class="progress mt-3" style="height: 6px;">
                    <div class="progress-bar bg-light" id="progressBar" style="width: 0%"></div>
                </div>
            </div>

            <div class="card-body p-4 p-md-5">
                <!-- Indicador de uso -->
                {% if modo == 'invitado' %}
                <div class="alert alert-warning d-flex align-items-center">
                    <i class="fas fa-user-clock fa-2x me-3"></i>
                    <div>
                        <strong>Modo Invitado:</strong> 
                        Te quedan <span class="badge bg-warning text-dark">{{ restantes }}</span> diagnóstico(s) gratis.
                        <a href="/register" class="alert-link fw-bold">Regístrate para acceso ilimitado</a>
                    </div>
                </div>
                {% else %}
                <div class="alert alert-info d-flex align-items-center">
                    <i class="fas fa-chart-line fa-2x me-3"></i>
                    <div>
                        <strong class="d-block">{{ mensaje }}</strong>
                        <small class="opacity-75">Complete todos los campos obligatorios marcados con *</small>
                    </div>
                </div>
                {% endif %}

                <!-- Formulario con pasos -->
                <form method="POST" action="/diagnostico" id="diagnosticoForm" class="needs-validation" novalidate>
                    <!-- Paso 1: Información de la Empresa -->
                    <div class="form-step active" id="step1">
                        <div class="step-header mb-4">
                            <span class="step-number">1</span>
                            <h4 class="step-title">
                                <i class="fas fa-building me-2"></i>Información de la Empresa
                            </h4>
                        </div>

                        <div class="mb-4">
                            <label for="empresa" class="form-label fw-bold">
                                Nombre de la empresa <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-building"></i>
                                </span>
                                <input type="text" 
                                       id="empresa" 
                                       name="empresa" 
                                       class="form-control form-control-lg" 
                                       placeholder="Ej: Mi Empresa S.A."
                                       required
                                       maxlength="100">
                            </div>
                            <div class="form-text">
                                Ingrese el nombre legal o comercial de su organización
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="sector" class="form-label fw-bold">
                                Sector empresarial <span class="text-danger">*</span>
                            </label>
                            <select id="sector" name="sector" class="form-select form-select-lg" required>
                                <option value="">-- Seleccione su sector --</option>
                                <option value="Tecnología">Tecnología y Telecomunicaciones</option>
                                <option value="Financiero">Servicios Financieros</option>
                                <option value="Salud">Salud y Farmacéutico</option>
                                <option value="Retail">Retail y Comercio</option>
                                <option value="Manufactura">Manufactura e Industria</option>
                                <option value="Servicios">Servicios Profesionales</option>
                                <option value="Educación">Educación</option>
                                <option value="Gobierno">Gobierno</option>
                                <option value="Otro">Otro sector</option>
                            </select>
                        </div>

                        <div class="mb-4">
                            <label for="tamano" class="form-label fw-bold">
                                Tamaño de la empresa <span class="text-danger">*</span>
                            </label>
                            <div class="row g-3">
                                {% for tam in [
                                    ('Micro', '1-10 empleados', 'fas fa-user'),
                                    ('Pequeña', '11-50 empleados', 'fas fa-users'),
                                    ('Mediana', '51-250 empleados', 'fas fa-building'),
                                    ('Grande', '+250 empleados', 'fas fa-city')
                                ] %}
                                <div class="col-md-6 col-lg-3">
                                    <input type="radio" 
                                           class="btn-check" 
                                           name="tamano" 
                                           id="tamano{{ loop.index }}" 
                                           value="{{ tam[0] }}" 
                                           required>
                                    <label class="btn btn-outline-primary w-100 h-100 p-3" for="tamano{{ loop.index }}">
                                        <i class="{{ tam[2] }} fa-2x mb-2"></i><br>
                                        <strong>{{ tam[0] }}</strong><br>
                                        <small class="text-muted">{{ tam[1] }}</small>
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="text-end">
                            <button type="button" class="btn btn-primary btn-lg next-step" data-next="2">
                                Siguiente <i class="fas fa-arrow-right ms-2"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Paso 2: Evaluación de Riesgo -->
                    <div class="form-step" id="step2">
                        <div class="step-header mb-4">
                            <span class="step-number">2</span>
                            <h4 class="step-title">
                                <i class="fas fa-exclamation-triangle me-2"></i>Evaluación de Riesgo
                            </h4>
                        </div>

                        <div class="mb-4">
                            <label for="tipo_riesgo" class="form-label fw-bold">
                                Tipo de riesgo principal <span class="text-danger">*</span>
                            </label>
                            <select id="tipo_riesgo" name="tipo_riesgo" class="form-select form-select-lg" required>
                                <option value="">-- Seleccione el riesgo más crítico --</option>
                                <option value="Tecnológico" data-icon="fa-network-wired">Tecnológico (Ransomware, malware, ataques)</option>
                                <option value="Financiero" data-icon="fa-money-bill-wave">Financiero (Fraude, robo de datos bancarios)</option>
                                <option value="Operativo" data-icon="fa-cogs">Operativo (Interrupción de servicios)</option>
                                <option value="Reputacional" data-icon="fa-star">Reputacional (Fuga de datos de clientes)</option>
                                <option value="Legal" data-icon="fa-gavel">Legal (Incumplimiento normativo)</option>
                            </select>
                        </div>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="impacto" class="form-label fw-bold">
                                    Nivel de impacto <span class="text-danger">*</span>
                                </label>
                                <select id="impacto" name="impacto" class="form-select" required>
                                    <option value="">-- Seleccione impacto --</option>
                                    <option value="Alto" data-color="danger">Alto - Parálisis del negocio</option>
                                    <option value="Medio" data-color="warning">Medio - Afectación temporal</option>
                                    <option value="Bajo" data-color="success">Bajo - Impacto menor</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="probabilidad" class="form-label fw-bold">
                                    Probabilidad <span class="text-danger">*</span>
                                </label>
                                <select id="probabilidad" name="probabilidad" class="form-select" required>
                                    <option value="">-- Seleccione probabilidad --</option>
                                    <option value="Alta" data-color="danger">Alta - Muy probable</option>
                                    <option value="Media" data-color="warning">Media - Puede ocurrir</option>
                                    <option value="Baja" data-color="success">Baja - Poco probable</option>
                                </select>
                            </div>
                        </div>

                        <div class="row mt-4">
                            <div class="col-6">
                                <button type="button" class="btn btn-outline-secondary btn-lg prev-step" data-prev="1">
                                    <i class="fas fa-arrow-left me-2"></i> Anterior
                                </button>
                            </div>
                            <div class="col-6 text-end">
                                <button type="button" class="btn btn-primary btn-lg next-step" data-next="3">
                                    Siguiente <i class="fas fa-arrow-right ms-2"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Paso 3: Observaciones -->
                    <div class="form-step" id="step3">
                        <div class="step-header mb-4">
                            <span class="step-number">3</span>
                            <h4 class="step-title">
                                <i class="fas fa-comment me-2"></i>Observaciones Adicionales
                            </h4>
                        </div>

                        <div class="mb-4">
                            <label for="observaciones" class="form-label fw-bold">
                                Medidas de seguridad actuales o comentarios
                                <span class="badge bg-success ms-2">Opcional</span>
                            </label>
                            <textarea id="observaciones" 
                                      name="observaciones" 
                                      class="form-control" 
                                      rows="6" 
                                      placeholder="Describa las medidas de seguridad que ya tiene implementadas, como:
- Antivirus y firewall
- Sistema de respaldos
- Políticas de acceso
- Capacitación del personal
- Certificaciones de seguridad
- Otros controles implementados..."
                                      maxlength="1000"></textarea>
                            <div class="form-text d-flex justify-content-between">
                                <span>
                                    <i class="fas fa-lightbulb text-warning"></i> 
                                    Proporcionar más detalles mejora la precisión del diagnóstico
                                </span>
                                <span id="charCount">0/1000</span>
                            </div>
                        </div>

                        <!-- Resumen antes de enviar -->
                        <div class="card bg-light mb-4">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-clipboard-check me-2"></i>Resumen del Diagnóstico
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row small">
                                    <div class="col-md-4">
                                        <strong>Empresa:</strong><br>
                                        <span id="resumenEmpresa">-</span>
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Sector:</strong><br>
                                        <span id="resumenSector">-</span>
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Tamaño:</strong><br>
                                        <span id="resumenTamano">-</span>
                                    </div>
                                </div>
                                <hr class="my-2">
                                <div class="row small">
                                    <div class="col-md-4">
                                        <strong>Riesgo:</strong><br>
                                        <span id="resumenRiesgo">-</span>
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Impacto:</strong><br>
                                        <span id="resumenImpacto">-</span>
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Probabilidad:</strong><br>
                                        <span id="resumenProbabilidad">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-6">
                                <button type="button" class="btn btn-outline-secondary btn-lg prev-step" data-prev="2">
                                    <i class="fas fa-arrow-left me-2"></i> Anterior
                                </button>
                            </div>
                            <div class="col-6 text-end">
                                <button type="submit" class="btn btn-success btn-lg">
                                    <i class="fas fa-search me-2"></i> Generar Diagnóstico
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
.step-header {
    display: flex;
    align-items: center;
    padding-bottom: 1rem;
    border-bottom: 2px solid #e9ecef;
}

.step-number {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    background: #0d6efd;
    color: white;
    border-radius: 50%;
    font-weight: bold;
    margin-right: 1rem;
}

.step-title {
    margin: 0;
    color: #495057;
}

.form-step {
    display: none;
}

.form-step.active {
    display: block;
}

.btn-check:checked + .btn {
    border-color: #0d6efd;
    background-color: #0d6efd;
    color: white;
}

/* Validación */
.was-validated .form-control:invalid,
.was-validated .form-select:invalid {
    border-color: #dc3545;
    padding-right: calc(1.5em + 0.75rem);
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath d='m5.8 3.6.4.4.4-.4'/%3e%3cpath d='M6 7v1'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Navegación entre pasos
    const steps = document.querySelectorAll('.form-step');
    const progressBar = document.getElementById('progressBar');
    let currentStep = 1;

    function showStep(stepNumber) {
        steps.forEach(step => step.classList.remove('active'));
        document.getElementById(`step${stepNumber}`).classList.add('active');
        
        // Actualizar barra de progreso
        const progress = ((stepNumber - 1) / (steps.length - 1)) * 100;
        progressBar.style.width = `${progress}%`;
        
        currentStep = stepNumber;
        updateSummary();
    }

    // Botones siguiente/anterior
    document.querySelectorAll('.next-step').forEach(button => {
        button.addEventListener('click', function() {
            const nextStep = parseInt(this.dataset.next);
            if (validateStep(currentStep)) {
                showStep(nextStep);
            }
        });
    });

    document.querySelectorAll('.prev-step').forEach(button => {
        button.addEventListener('click', function() {
            const prevStep = parseInt(this.dataset.prev);
            showStep(prevStep);
        });
    });

    // Contador de caracteres
    const observaciones = document.getElementById('observaciones');
    const charCount = document.getElementById('charCount');
    
    observaciones.addEventListener('input', function() {
        charCount.textContent = `${this.value.length}/1000`;
    });

    // Validación de pasos
    function validateStep(step) {
        const currentStepElement = document.getElementById(`step${step}`);
        const inputs = currentStepElement.querySelectorAll('[required]');
        let isValid = true;

        inputs.forEach(input => {
            if (!input.value.trim()) {
                input.classList.add('is-invalid');
                isValid = false;
            } else {
                input.classList.remove('is-invalid');
            }
        });

        if (!isValid) {
            currentStepElement.querySelector('.is-invalid').focus();
        }

        return isValid;
    }

    // Actualizar resumen
    function updateSummary() {
        document.getElementById('resumenEmpresa').textContent = 
            document.getElementById('empresa').value || '-';
        document.getElementById('resumenSector').textContent = 
            document.getElementById('sector').value || '-';
        document.getElementById('resumenTamano').textContent = 
            document.querySelector('input[name="tamano"]:checked')?.value || '-';
        document.getElementById('resumenRiesgo').textContent = 
            document.getElementById('tipo_riesgo').value || '-';
        document.getElementById('resumenImpacto').textContent = 
            document.getElementById('impacto').value || '-';
        document.getElementById('resumenProbabilidad').textContent = 
            document.getElementById('probabilidad').value || '-';
    }

    // Event listeners para actualizar resumen en tiempo real
    document.querySelectorAll('#diagnosticoForm input, #diagnosticoForm select').forEach(element => {
        element.addEventListener('change', updateSummary);
        element.addEventListener('input', updateSummary);
    });

    // Validación del formulario completo
    document.getElementById('diagnosticoForm').addEventListener('submit', function(e) {
        if (!validateStep(currentStep)) {
            e.preventDefault();
            return;
        }
        
        // Mostrar loading
        const submitBtn = this.querySelector('button[type="submit"]');
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Procesando...';
        submitBtn.disabled = true;
    });

    // Inicializar primer paso
    showStep(1);
});
</script>
{% endblock %}